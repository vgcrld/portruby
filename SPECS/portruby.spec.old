%define debug_package %{nil}

%define galileo_base  /opt/galileo
%define galileo_ruby  /opt/galileo/ruby
%define rubyver       2.5.3

Name:           portruby
Version:        1.0
Release:        2
Summary:        A test to build an rpm to instal Ruby
Group:	        dev
License:	      MIT
URL:	          https://galileosuite.com	
Source0:        ruby-%{rubyver}.tar.gz
Source1:        bundler-1.17.1.gem
BuildRequires:  readline-devel ncurses-devel gdbm-devel glibc-devel gcc openssl-devel make libyaml-devel libffi-devel zlib-devel
Requires:       readline ncurses gdbm glibc openssl libyaml libffi zlib

%description
Ruby is the interpreted scripting language for quick and easy
object-oriented programming.  It has many features to process text
files and to do system management tasks (as in Perl).  It is simple,
straight-forward, and extensible.

%prep
%setup -n ruby-%{rubyver}

%build
export CFLAGS="$RPM_OPT_FLAGS -Wall -fno-strict-aliasing"
./configure --disable-install-doc --prefix=%{galileo_ruby}
make %{?_smp_mflags}

%install
# installing binaries ...
make install DESTDIR=$RPM_BUILD_ROOT
 
# Install the gems in SOURCE
export PATH=${RPM_BUILD_ROOT}/%{galileo_ruby}/bin:$PATH
gem install ${RPM_SOURCE_DIR}/bundler-1.17.1.gem --bindir %{_tmppath}/gems/bin --install-dir %{_tmppath}/gems/lib --no-document --local

# gem data 
cp    %{_tmppath}/gems/bin/* ${RPM_BUILD_ROOT}/%{galileo_ruby}/bin/
cp -r %{_tmppath}/gems/lib/* ${RPM_BUILD_ROOT}/%{galileo_ruby}/lib/ruby/gems/2.5.0

# Bundle install - copy the 
bundle install --gemfile ${RPM_SOURCE_DIR}/Gemfile --path %{_tmppath}/gems/lib/
cp -r %{_tmppath}/gems/lib ${RPM_BUILD_ROOT}/%{galileo_ruby}/lib/ruby/gems/2.5.0/

%files
%defattr(-, root, root, 755 )
%{galileo_base}

%changelog
* Tue Dec 4 2018 Rich Davis <rdavis@galileosuite.com>
- Looks good.
